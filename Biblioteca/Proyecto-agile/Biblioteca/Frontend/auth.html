<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Autenticación - BiblioDigital</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700;800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/auth.css">
</head>

<body class="auth-page">
  <div id="toast-container"></div>

  <div class="auth-container">
    <div class="auth-card" id="authCard">

    </div>
  </div>

  <script src="js/utils/storage.js"></script>
  <script src="js/utils/http.js"></script>
  <script src="js/services/auth.service.js"></script>
  <script src="js/components/toast.js"></script>
  <script>

    const AuthViews = {
      login: `
        <div class="auth-header">
          <div class="auth-logo"><i class="fas fa-book-open"></i></div>
          <h1 class="auth-title">Bienvenido de nuevo</h1>
          <p class="auth-subtitle">Inicia sesión para continuar</p>
        </div>
        <form id="loginForm" class="auth-form">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" id="email" class="form-control" placeholder="tu@email.com" required>
          </div>
          <div class="form-group">
            <label class="form-label">Contraseña</label>
            <div class="input-group">
              <input type="password" id="password" class="form-control" placeholder="••••••••" required>
              <button type="button" class="input-action" onclick="togglePassword('password')"><i class="fas fa-eye"></i></button>
            </div>
          </div>
          <button type="submit" class="btn btn-primary btn-block">Iniciar Sesión</button>
        </form>
        <div class="auth-divider"><span>¿No tienes cuenta?</span></div>
        <div class="auth-links">
          <button onclick="renderView('registerCustomer')" class="btn btn-outline btn-block">Registrarse</button>
        </div>
      `,
      registerCustomer: `
        <div class="auth-header">
          <div class="auth-logo"><i class="fas fa-user-plus"></i></div>
          <h1 class="auth-title">Crear cuenta</h1>
          <p class="auth-subtitle">Únete a nuestra biblioteca digital</p>
        </div>
        <form id="registerForm" class="auth-form">
          <div class="form-row">
            <div class="form-group"><label class="form-label">Nombre</label><input type="text" id="firstName" class="form-control" required></div>
            <div class="form-group"><label class="form-label">Apellido</label><input type="text" id="lastName" class="form-control" required></div>
          </div>
          <div class="form-group"><label class="form-label">Email</label><input type="email" id="email" class="form-control" required></div>
          <div class="form-group"><label class="form-label">Contraseña</label><input type="password" id="password" class="form-control" required></div>
          <div class="form-group"><label class="form-label">Dirección</label><textarea id="shippingAddress" class="form-control" rows="2" required></textarea></div>
          <button type="submit" class="btn btn-primary btn-block">Registrarse</button>
        </form>
        <div class="auth-links mt-4 text-center">
          <button onclick="renderView('login')" class="link-text">¿Ya tienes cuenta? Inicia Sesión</button>
        </div>
      `
    };

    function renderView(viewName) {
      const card = document.getElementById('authCard');
      card.innerHTML = AuthViews[viewName];

      const form = card.querySelector('form');
      if (form) {
        form.addEventListener('submit', (e) => handleSubmit(e, viewName));
      }
    }

    function togglePassword(id) {
      const input = document.getElementById(id);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    async function handleSubmit(e, viewName) {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Procesando...';

      try {
        if (viewName === 'login') {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          await AuthService.login(email, password);
          window.location.href = 'app.html';
        } else if (viewName === 'registerCustomer') {
          const data = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            shippingAddress: document.getElementById('shippingAddress').value
          };
          await AuthService.registerCustomer(data);
          Toast.show('Registro exitoso. Por favor inicia sesión.', 'success');
          setTimeout(() => renderView('login'), 1500);
        }
      } catch (err) {
        console.error(err);
        Toast.show(err.message || 'Error en la autenticación', 'error');
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (Storage.getAuth()) {
        window.location.href = 'app.html';
        return;
      }

      const hash = window.location.hash;
      if (hash === '#register') {
        renderView('registerCustomer');
      } else {
        renderView('login');
      }
    });

  </script>
</body>

</html>